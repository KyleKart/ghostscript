<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>GhostScript Playground</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f0f0f0;
      color: #333;
    }

    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      font-size: 14px;
      margin-bottom: 10px;
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
    }

    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
    }

    pre {
      background: #222;
      color: #eee;
      padding: 15px;
      overflow-x: auto;
      white-space: pre-wrap;
      border-radius: 4px;
      margin-top: 20px;
      min-height: 100px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
    }

    #consoleOutput {
      background: #000;
      color: #0f0;
      font-family: monospace;
      padding: 10px;
      border-radius: 4px;
      height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    ghost {
      display: none !important;
    }
  </style>
</head>

<body>

  <h1>GhostScript Playground</h1>

  <textarea id="ghostSource" spellcheck="false">
out("Hello from GhostScript!")
var x = 5
if (x > 2)
  out("x is greater than 2");
</textarea>

  <label>Output JavaScript:</label>
  <pre id="jsOutput">// Transformed JS will appear here</pre>

  <button id="runBtn">Run</button>

  <h2>Console output:</h2>
  <pre id="consoleOutput">// Output appears here</pre>

  <ghost id="runner"></ghost>

  <script>
    const consoleOutput = document.getElementById('consoleOutput');
    const jsOutput = document.getElementById('jsOutput');
    const originalLog = console.log;
    const originalErr = console.error;

    console.log = (...args) => {
      consoleOutput.textContent += args.join(' ') + '\n';
      originalLog(...args);
    };

    console.error = (...args) => {
      consoleOutput.textContent += '[ERR] ' + args.join(' ') + '\n';
      originalErr(...args);
    };

    function parseGhostScript(ghostSource) {
      let ghostCode = ghostSource.replace(/#(\w+)/g, (_, v) => v);

      ghostCode = ghostCode.replace(/out\((.*?)\)/g, 'console.log($1)');
      ghostCode = ghostCode.replace(/err\((.*?)\)/g, 'console.error($1)');
      ghostCode = ghostCode.replace(/\bvar\b/g, 'let');
      ghostCode = ghostCode.replace(/for\s*\(\s*(\d+)\s*\)/, 'for (let i = 0; i < $1; i++)');

      const lines = ghostCode.split('\n').map(line => line.trim());
      const controlKeywords = ['if', 'else if', 'else', 'while', 'switch', 'for', 'per'];

      let outputLines = [];
      let blockStack = [];
      let wsVar = null;

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // Handle 'from(wsVar)' blocks
        const fromMatch = line.match(/^from\s*\(\s*(\w+)\s*\)/);
        if (fromMatch) {
          wsVar = fromMatch[1];
          outputLines.push(`${wsVar}.onmessage = async (event) => {`);
          blockStack.push('from');
          continue;
        }

        const perMatch = line.match(/^per\s*\(\s*(\d+)\s*\)$/);
        if (perMatch) {
          const n = perMatch[1];
          outputLines.push(`if (i % ${n} === 0) {`);
          blockStack.push('block');  // open block for this if
          continue;
        }


        // Replace wsVar.msg inside from block
        if (blockStack.includes('from') && wsVar && line.includes(`${wsVar}.msg`)) {
          line = line.replaceAll(`${wsVar}.msg`, 'event.data');
        }

        // Handle WebSocket shorthand
        const wssMatch = line.match(/^let\s+(\w+)\s*=\s*wss\((.+?)\)/);
        if (wssMatch) {
          const [_, varName, expr] = wssMatch;
          outputLines.push(`let ${varName} = new WebSocket("wss://" + ${expr});`);
          continue;
        }

        // Skip empty lines and comments
        if (line === '' || line.startsWith('#') || line.startsWith('//')) {
          continue;
        }

        // Check if line starts a control block
        const matchedControl = controlKeywords.some(kw => {
          const regex = new RegExp(`^${kw}(\\s|\\()`);
          return regex.test(line);
        });

        if (matchedControl) {
          outputLines.push(line + ' {');
          blockStack.push('block');
          continue;
        }

        outputLines.push(line);

        // If line ends with semicolon, close the current block if any
        if (line.endsWith(';') && blockStack.length > 0) {
          outputLines.push('}');
          blockStack.pop();
        }
      }

      // Close any remaining open blocks
      while (blockStack.length > 0) {
        outputLines.push('}');
        blockStack.pop();
      }

      return outputLines.join('\n');
    }


    function runGhostTags() {
      const blocks = document.querySelectorAll('ghost');

      blocks.forEach(block => {
        const isExternal = block.hasAttribute('src');
        const runCode = code => {
          const parsed = parseGhostScript(code);
          try {
            eval(parsed);
          } catch (e) {
            console.error('GhostScript runtime error:', e);
          }
        };

        if (isExternal) {
          const src = block.getAttribute('src');
          fetch(src)
            .then(res => res.text())
            .then(runCode)
            .catch(err => {
              console.error(`GhostScript failed to load "${src}":`, err);
            });
        } else {
          runCode(block.textContent);
        }
      });
    }

    document.getElementById('runBtn').addEventListener('click', () => {
      const code = document.getElementById('ghostSource').value;
      document.getElementById('runner').textContent = code;
      consoleOutput.textContent = '';

      const transformed = parseGhostScript(code);
      jsOutput.textContent = transformed;

      runGhostTags();
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runGhostTags);
    } else {
      runGhostTags();
    }
  </script>

</body>

</html>