<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GhostScript Runner</title>
</head>
<body>
<script>
const params = new URLSearchParams(location.search);
const scriptURL = params.get("script");

function parseGhostScript(ghostSource) {
  let ghostCode = ghostSource.replace(/#(\w+)/g, (_, v) => v);

  ghostCode = ghostCode.replace(/out\((.*?)\)/g, 'console.log($1)');
  ghostCode = ghostCode.replace(/err\((.*?)\)/g, 'console.error($1)');
  ghostCode = ghostCode.replace(/\bvar\b/g, 'let');
  ghostCode = ghostCode.replace(/for\s*\(\s*(\d+)\s*\)/, 'for (let i = 0; i < $1; i++)');
  ghostCode = ghostCode.replace(/borrow\s+"(\w+)"/g, 'const $1 = await import("./ghost-modules/$1.js")');
  ghostCode = ghostCode.replace(/(["'`].+?["'`]|\w+)\s*\.\+\s*(["'`].+?["'`]|\w+)/g, (m, l, r) => `[${l}, ${r}].join("")`);

  const lines = ghostCode.split('\n').map(line => line.trim());
  const controlKeywords = ['if', 'else if', 'else', 'while', 'switch', 'for', 'per'];

  let outputLines = [];
  let blockStack = [];
  let wsVar = null;

  for (let line of lines) {
    if (line === '' || line.startsWith('#') || line.startsWith('//')) continue;

    const fromMatch = line.match(/^from\s*\(\s*(\w+)\s*\)/);
    if (fromMatch) {
      wsVar = fromMatch[1];
      outputLines.push(`${wsVar}.onmessage = async (event) => {`);
      blockStack.push('from');
      continue;
    }

    const perMatch = line.match(/^per\s*\(\s*(\d+)\s*\)$/);
    if (perMatch) {
      const n = perMatch[1];
      outputLines.push(`if (i % ${n} === 0) {`);
      blockStack.push('block');
      continue;
    }

    if (blockStack.includes('from') && wsVar && line.includes(`${wsVar}.msg`)) {
      line = line.replaceAll(`${wsVar}.msg`, 'event.data');
    }

    const wssMatch = line.match(/^let\s+(\w+)\s*=\s*wss\((.+?)\)/);
    if (wssMatch) {
      const [_, varName, expr] = wssMatch;
      outputLines.push(`let ${varName} = new WebSocket("wss://" + ${expr});`);
      continue;
    }

    const matchedControl = controlKeywords.some(kw => {
      const regex = new RegExp(`^${kw}(\\s|\\()`);
      return regex.test(line);
    });

    if (matchedControl) {
      outputLines.push(line + ' {');
      blockStack.push('block');
      continue;
    }

    if (line === 'end') {
      if (blockStack.length > 0) {
        outputLines.push('}');
        blockStack.pop();
      } else {
        outputLines.push('// stray end');
      }
      continue;
    }

    outputLines.push(line + ';');
  }

  while (blockStack.length > 0) {
    outputLines.push('}');
    blockStack.pop();
  }

  return outputLines.join('\n');
}

function runGhostCode(code) {
  const parsed = parseGhostScript(code);
  const asyncCode = `
(async () => {
  ${parsed}
})();
`;
  try {
    eval(asyncCode);
  } catch (e) {
    console.error("GhostScript runtime error:", e);
  }
}

if (scriptURL) {
  fetch(scriptURL)
    .then(res => res.text())
    .then(runGhostCode)
    .catch(err => console.error("Failed to load .ghost file:", err));
} else {
  console.error("No ?script= URL parameter provided.");
}
</script>
</body>
</html>